<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Kolam AR Mode</title>
<style>
body, html {
 margin: 0; padding: 0; overflow: hidden;
 font-family: Arial, sans-serif;
 background: #000;
 height: 100vh;
 color: #fff;
}
#ui {
 position: fixed;
 top: 20px;
 left: 20px;
 right: 20px;
 z-index: 100;
 display: flex;
 flex-direction: column;
 gap: 10px;
 background: rgba(0,0,0,0.5);
 padding: 10px;
 border-radius: 8px;
}
button, input[type=file] {
 padding: 12px;
 font-size: 16px;
 border-radius: 6px;
 border: none;
}
</style>
</head>
<body>
<div id="ui">
    <input type="file" id="fileInput" accept="image/*" />
<button id="startAR">Start AR Mode</button>
<button id="clearAll">Clear All Images</button>
<div id="status">Select a kolam image & tap Start AR Mode</div>
</div>

<script src="https://unpkg.com/three@0.157.0/build/three.js"></script>
<script>
let scene, camera, renderer, session;
let hitTestSource = null;
let localReferenceSpace = null;
let selectedImageTexture = null;
let reticle, placedImages = [];

document.getElementById('fileInput').addEventListener('change', function(e) {
 const file = e.target.files[0];
 if(file && file.type.startsWith('image/')) {
  const reader = new FileReader();
  reader.onload = function(event) {
   const loader = new THREE.TextureLoader();
   selectedImageTexture = loader.load(event.target.result);
   selectedImageTexture.flipY = false;
   document.getElementById('status').textContent = 'Image loaded! Tap "Start AR Mode".';
  }
  reader.readAsDataURL(file);
 }
});

document.getElementById('startAR').onclick = async function () {
 if (!selectedImageTexture) {
  alert("Please upload a kolam image first!");
  return;
 }
 try {
  session = await navigator.xr.requestSession('immersive-ar', {requiredFeatures: ['hit-test']});
  setupSession(session);
 } catch(error) {
  alert('AR not supported or permission denied.');
 }
};

document.getElementById('clearAll').onclick = function () {
 placedImages.forEach(img => {
  scene.remove(img);
  img.geometry.dispose();
  img.material.dispose();
 });
 placedImages = [];
 document.getElementById('status').textContent = 'Cleared all kolam images';
};

async function setupSession(session) {
 const canvas = document.createElement('canvas');
 const gl = canvas.getContext('webgl', {xrCompatible: true});
 document.body.appendChild(canvas);
 renderer = new THREE.WebGLRenderer({canvas: canvas, context: gl, alpha: true});
 renderer.autoClear = false;
 renderer.setSize(window.innerWidth, window.innerHeight);
 renderer.xr.enabled = true;
 renderer.xr.setSession(session);

 scene = new THREE.Scene();
 camera = new THREE.PerspectiveCamera();

 localReferenceSpace = await session.requestReferenceSpace('local');

 const viewerSpace = await session.requestReferenceSpace('viewer');
 hitTestSource = await session.requestHitTestSource({space: viewerSpace});

 const geometry = new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2);
 const material = new THREE.MeshBasicMaterial({color: 0x00aaff, opacity: 0.7, transparent: true});
 reticle = new THREE.Mesh(geometry, material);
 reticle.visible = false;
 scene.add(reticle);

 session.addEventListener('select', onSelect);

 session.requestAnimationFrame(onXRFrame);
}

function onXRFrame(time, frame) {
 session.requestAnimationFrame(onXRFrame);
 const pose = frame.getViewerPose(localReferenceSpace);
 if (!pose) return;

 const hitTestResults = frame.getHitTestResults(hitTestSource);
 if (hitTestResults.length > 0) {
  const hitPose = hitTestResults[0].getPose(localReferenceSpace);
  reticle.visible = true;
  reticle.position.set(hitPose.transform.position.x, hitPose.transform.position.y, hitPose.transform.position.z);
  reticle.quaternion.set(hitPose.transform.orientation.x, hitPose.transform.orientation.y, hitPose.transform.orientation.z, hitPose.transform.orientation.w);
 } else {
  reticle.visible = false;
 }

 camera.matrix.fromArray(pose.views[0].transform.matrix);
 camera.projectionMatrix.fromArray(pose.views[0].projectionMatrix);
 camera.updateMatrixWorld(true);

 renderer.clearDepth();
 renderer.render(scene, camera);
}

function onSelect() {
 if (!reticle.visible || !selectedImageTexture) return;

 const aspect = selectedImageTexture.image.width / selectedImageTexture.image.height;
 const width = 0.5; // 50 cm width
 const height = width / aspect;

 const geometry = new THREE.PlaneGeometry(width, height);
 const material = new THREE.MeshBasicMaterial({map: selectedImageTexture, transparent: true});
 const imgPlane = new THREE.Mesh(geometry, material);

 imgPlane.position.copy(reticle.position);
 imgPlane.quaternion.copy(reticle.quaternion);

 scene.add(imgPlane);
 placedImages.push(imgPlane);

 document.getElementById('status').textContent = `Placed ${placedImages.length} kolam image(s). Tap elsewhere to add more.`;
}
</script>
</body>
</html>
